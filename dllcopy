#!/bin/bash
### author: Neolux Lee
### date: 2026-02-10

# 检查参数数量
if [ $# -ne 2 ]; then
    echo "Usage: $0 <exe_path> <dll_list>"
    exit 1
fi

exe_path=$1
dll_list=$2

# 检查环境变量 DLLPATH
if [ -z "$DLLPATH" ]; then
    echo "Error: DLLPATH environment variable is not set"
    exit 1
fi

# 获取可执行文件所在目录
exe_dir=$(dirname "$exe_path")

# 检查 DLL 列表文件是否存在
if [ ! -f "$dll_list" ]; then
    echo "Error: DLL list file '$dll_list' not found"
    exit 1
fi

# 读取 DLL 列表并复制
while IFS= read -r dll; do
    echo "Processing DLL: '$dll'"
    # 跳过空行
    if [ -z "$dll" ]; then
        continue
    fi

    found=no
    # 分割 DLLPATH
    IFS=':' read -ra paths <<< "$DLLPATH"
    for dir in "${paths[@]}"; do
        if [ -f "$dir/$dll" ]; then
            cp "$dir/$dll" "$exe_dir/"
            echo "Copied $dll from $dir to $exe_dir"
            found=yes
            break
        fi
    done

    if [ "$found" = "no" ]; then
        echo "Warning: DLL '$dll' not found in DLLPATH"
    fi
done < "$dll_list"

echo "DLL copying completed."
